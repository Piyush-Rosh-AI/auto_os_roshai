<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Auto OS: Velocity Smoother</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Auto OS
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Velocity Smoother </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <code>nav2_velocity_smoother</code> is a package containing a lifecycle-component node for smoothing velocities sent by Nav2 to robot controllers. The aim of this package is to implement velocity, acceleration, and deadband smoothing from Nav2 to reduce wear-and-tear on robot motors and hardware controllers by smoothing out the accelerations/jerky movements that might be present with some local trajectory planners' control efforts.</p>
<p>It supports differential drive and omnidirectional robot platforms primarily, but is applicable to ackermann as well with some interpretations of <code>Twist</code>. It was built by <a href="https://www.linkedin.com/in/steve-macenski-41a985101/">Steve Macenski</a> while at <a href="https://www.sra.samsung.com/">Samsung Research</a>.</p>
<p>See its <a href="https://docs.nav2.org/configuration/packages/configuring-velocity-smoother.html">Configuration Guide Page</a> for additional parameter descriptions.</p>
<h1><a class="anchor" id="autotoc_md246"></a>
Features</h1>
<p>This package was created to do the following:</p>
<ul>
<li>Limit velocity commands by kinematic constraints, including velocity and acceleration</li>
<li>Limit velocities based on deadband regions</li>
<li>Stop sending velocities after a given timeout duration of no new commands (due to stopped navigation)</li>
<li>Send a zero-velocity command at velocity timeout to stop the robot, in case not properly handled</li>
<li>Support Omni and differential drive robots (e.g. X, Y, Theta)</li>
<li>Smooth velocities proportionally in the same direction as commanded, whenever possible within kinematic limits</li>
<li>Provide open loop and closed loop options</li>
<li>Component nodes for use in single-process systems and stand-alone node format</li>
<li>Dynamically reconfigurable parameters</li>
</ul>
<h1><a class="anchor" id="autotoc_md247"></a>
Design</h1>
<p>This is a lifecycle-component node, using the lifecycle manager for state management and composition for process management. It is designed to take in a command from Nav2's controller server and smooth it for use on robot hardware controllers. Thusly, it takes in a command via the <code>cmd_vel</code> topic and produces a smoothed output on <code>smoothed_cmd_vel</code>.</p>
<p>The node is designed on a regular timer running at a configurable rate. This is in contrast to simply computing a smoothed velocity command in the callback of each <code>cmd_vel</code> input from Nav2. This allows us to interpolate commands at a higher frequency than Nav2's local trajectory planners can provide. For example, if a local trajectory planner is running at 20hz, the velocity smoother can run at 100hz to provide approximately 5 messages to a robot controller which will be smoothed by kinematic limits at each timestep. This provides a more regular stream of commands to a robot base and interpolates commands between the current velocity and the desired velocity more finely for smoother acceleration / motion profiles. While this is not required, it is a nice design feature. It is possible to also simply run the smoother at <code>cmd_vel</code> rate to smooth velocities alone without interpolation.</p>
<p>There are two primary operation modes: open and closed loop. In open-loop, the node assumes that the robot was able to achieve the velocity send to it in the last command which was smoothed (which should be a good assumption if acceleration limits are set properly). This is useful when robot odometry is not particularly accurate or has significant latency relative to <code>smoothing_frequency</code> so there isn't a delay in the feedback loop. In closed-loop, the node will read from the odometry topic and apply a smoother over it to obtain the robot's current speed. This will be used to determine the robot's current velocity and therefore achievable velocity targets by the velocity, acceleration, and deadband constraints using live data.</p>
<h1><a class="anchor" id="autotoc_md248"></a>
Parameters</h1>
<p>See inline description of parameters in the <code>VelocitySmoother</code>.</p>
<div class="fragment"><div class="line">velocity_smoother:</div>
<div class="line">  ros__parameters:</div>
<div class="line">    smoothing_frequency: 20.0  # Rate to run smoother</div>
<div class="line">    scale_velocities: false  # scale velocities proportionally if any axis is outside of acceleration range to follow same vector, if possible</div>
<div class="line">    feedback: &quot;OPEN_LOOP&quot;  # Type of feedback for current speed. Open loop uses the last smoothed output. Closed loop uses robot odometry</div>
<div class="line">    max_velocity: [0.5, 0.0, 2.5]  # Maximum velocities, ordered [Vx, Vy, Vw]</div>
<div class="line">    min_velocity: [-0.5, 0.0, -2.5]  # Minimum velocities, ordered [Vx, Vy, Vw]</div>
<div class="line">    deadband_velocity: [0.0, 0.0, 0.0]  # A deadband of velocities below which they should be zero-ed out for sending to the robot base controller, ordered [Vx, Vy, Vw]</div>
<div class="line">    velocity_timeout: 1.0  # Time (s) after which if no new velocity commands are received to zero out and stop</div>
<div class="line">    max_accel: [2.5, 0.0, 3.2]  # Maximum acceleration, ordered [Ax, Ay, Aw]</div>
<div class="line">    max_decel: [-2.5, 0.0, -3.2]  # Maximum deceleration, ordered [Ax, Ay, Aw]</div>
<div class="line">    odom_topic: &quot;odom&quot;  # Topic of odometry to use for estimating current velocities</div>
<div class="line">    odom_duration: 0.1  # Period of time (s) to sample odometry information in for velocity estimation</div>
<div class="line">    enable_stamped_cmd_vel: false # Whether to stamp the velocity. True uses TwistStamped. False uses Twist</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md249"></a>
Topics</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Topic   </th><th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Use    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">smoothed_cmd_vel   </td><td class="markdownTableBodyNone">geometry_msgs/Twist or geometry_msgs/TwistStamped   </td><td class="markdownTableBodyNone">Publish smoothed velocities    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">cmd_vel   </td><td class="markdownTableBodyNone">geometry_msgs/Twist or geometry_msgs/TwistStamped   </td><td class="markdownTableBodyNone">Subscribe to input velocities   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md250"></a>
Install</h1>
<div class="fragment"><div class="line">sudo apt-get install ros-&lt;ros2-distro&gt;-nav2-velocity-smoother</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md251"></a>
Etc (Important Side Notes)</h1>
<p>Typically: if you have low rate odometry, you should use open-loop mode or set the smoothing frequency relatively similar to that of your <code>cmd_vel</code> topic. If you have high rate odometry, you can use closed-loop mode with a higher smoothing frequency since you'll have more up to date information to smooth based off of. Do not exceed the smoothing frequency to your odometry frequency in closed loop mode. Also consider the <code>odom_duration</code> to use relative to your odometry publication rate and noise characteristics. If the smoothing frequency out paces odometry or poorly selected <code>odom_duration</code>s are used, the robot can oscillate and/or accelerate slowly due to latency in closed loop mode.</p>
<p>When in doubt, open-loop is a reasonable choice for most users.</p>
<p>The minimum and maximum velocities for rotation (e.g. <code>Vw</code>) represent left and right turns. While we make it possible to specify these separately, most users would be wise to set these values the same (but signed) for rotation. Additionally, the parameters are signed, so it is important to specify maximum deceleration with negative signs to represent deceleration. Minimum velocities with negatives when moving backward, so backward movement can be restricted by setting this to <code>0</code>.</p>
<p>Deadband velocities are minimum thresholds, below which we set its value to <code>0</code>. This can be useful when your robot's breaking torque from stand still is non-trivial so sending very small values will pull high amounts of current.</p>
<p>The <code>VelocitySmoother</code> node makes use of a <a href="../nav2_util/README.md#twist-publisher-and-twist-subscriber-for-commanded-velocities">nav2_util::TwistSubscriber</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
